<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Session Viewer</title>
    <link rel="stylesheet" href="/static/style.css?v=9">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Force cache bust
        console.log('Page loaded at:', new Date().toISOString())
        console.log('Checking libraries...')
        window.addEventListener('load', function () {
            console.log('marked:', typeof marked)
            console.log('DOMPurify:', typeof DOMPurify)
            console.log('hljs:', typeof hljs)
        });
    </script>
</head>

<body>
    <div class="app-container">
        <!-- Left Sidebar: Projects -->
        <aside class="sidebar left-sidebar">
            <div class="sidebar-header">
                <h1>ğŸ“ Projects</h1>
                <input type="text" id="project-search" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œç´¢..." class="search-input">
            </div>
            <div class="projects-list" id="projects-list">
                <div class="loading">Loading projects...</div>
            </div>
        </aside>

        <!-- Middle Sidebar: Sessions -->
        <aside class="sidebar middle-sidebar">
            <div class="sidebar-header">
                <h2>ğŸ“ Sessions</h2>
                <div class="session-info" id="project-info">
                    <small>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                </div>
            </div>
            <div class="sessions-list" id="sessions-list">
                <div class="empty-state">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã¨<br>ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
        </aside>

        <!-- Right Sidebar: Prompts -->
        <aside class="sidebar right-sidebar">
            <div class="sidebar-header">
                <h2>ğŸ’¬ Prompts</h2>
                <div class="session-info" id="session-info">
                    <small>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                </div>
            </div>
            <div class="prompts-list" id="prompts-list">
                <div class="empty-state">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹ã¨<br>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
        </aside>

        <!-- Main Content: Response -->
        <main class="main-content">
            <div class="content-header">
                <h2>ğŸ¤– Response</h2>
                <div class="prompt-info" id="prompt-info"></div>
            </div>
            <div class="response-container" id="response-container">
                <div class="empty-state">
                    <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                    <p>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠã™ã‚‹ã¨<br>AIã®å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentEncodedPath = null
        let currentSessionId = null

        // Load projects on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects()
            setupSearch()
        })

        // Load all projects
        async function loadProjects() {
            const container = document.getElementById('projects-list')
            try {
                const response = await fetch('/api/projects')
                const projects = await response.json()

                if (projects.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p></div>'
                    return
                }

                container.innerHTML = projects.map(project => `
                    <div class="project-item" onclick="selectProject('${project.EncodedPath}', '${escapeHtml(getProjectName(project.DecodedPath))}', this)">
                        <div class="project-header">
                            <span class="project-icon">ğŸ“‚</span>
                            <span class="project-name">${escapeHtml(getProjectName(project.DecodedPath))}</span>
                        </div>
                    </div>
                `).join('')
            } catch (error) {
                container.innerHTML = '<div class="error">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>'
                console.error('Failed to load projects:', error)
            }
        }

        // Select a project and load its sessions
        async function selectProject(encodedPath, projectName, element) {
            // Remove previous active states
            document.querySelectorAll('.project-item').forEach(el => el.classList.remove('active'))
            element.classList.add('active')

            // Update project info
            document.getElementById('project-info').innerHTML = `<small>${projectName}</small>`

            // Load sessions
            await loadSessions(encodedPath)

            // Clear prompts and response
            document.getElementById('prompts-list').innerHTML = `
                <div class="empty-state">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹ã¨<br>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            `
            document.getElementById('response-container').innerHTML = `
                <div class="empty-state">
                    <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                    <p>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠã™ã‚‹ã¨<br>AIã®å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            `
        }

        // Load sessions for a project
        async function loadSessions(encodedPath) {
            const container = document.getElementById('sessions-list')
            container.innerHTML = '<div class="loading">Loading sessions...</div>'

            try {
                const response = await fetch(`/api/projects/${encodedPath}/sessions`)
                const sessions = await response.json()

                if (sessions.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p></div>'
                    return
                }

                container.innerHTML = sessions.map(session => `
                    <div class="session-item" onclick="selectSession('${encodedPath}', '${session.ID}', this)">
                        <div class="session-date">${formatDate(session.StartTime)}</div>
                        <div class="session-preview">${escapeHtml(session.FirstMessage.substring(0, 50))}${session.FirstMessage.length > 50 ? '...' : ''}</div>
                        <div class="session-meta">
                            <span>ğŸ’¬ ${session.MessageCount}</span>
                        </div>
                    </div>
                `).join('')
            } catch (error) {
                container.innerHTML = '<div class="error">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>'
                console.error('Failed to load sessions:', error)
            }
        }

        // Select a session and load its prompts
        async function selectSession(encodedPath, sessionId, element) {
            // Remove previous active states
            document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'))
            element.classList.add('active')

            currentEncodedPath = encodedPath
            currentSessionId = sessionId

            // Update session info
            document.getElementById('session-info').innerHTML = `<small>Session: ${sessionId}</small>`

            // Load prompts in right sidebar
            await loadPrompts(encodedPath, sessionId)

            // Clear response in main area
            document.getElementById('response-container').innerHTML = `
                <div class="empty-state">
                    <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                    <p>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠã™ã‚‹ã¨<br>AIã®å›ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            `
        }

        // Load conversation threads for a session
        async function loadPrompts(encodedPath, sessionId) {
            const container = document.getElementById('prompts-list')
            container.innerHTML = '<div class="loading">Loading conversation threads...</div>'

            try {
                const response = await fetch(`/api/projects/${encodedPath}/sessions/${sessionId}/prompts`)
                const threads = await response.json()

                if (threads.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“</p></div>'
                    return
                }

                container.innerHTML = threads.map(thread => {
                    const firstPromptIndex = thread.prompts[0].index
                    const promptList = thread.prompts.map(prompt => `
                        <div class="thread-prompt-item" onclick="selectPrompt(${prompt.index}, this)">
                            <div class="thread-prompt-preview">${escapeHtml(prompt.content.substring(0, 60))}${prompt.content.length > 60 ? '...' : ''}</div>
                        </div>
                    `).join('')

                    return `
                        <div class="thread-item">
                            <div class="thread-header" onclick="selectThreadPrompt(${firstPromptIndex}, '${thread.id}', this)">
                                <div class="thread-info">
                                    <div class="thread-summary">${escapeHtml(thread.summary)}</div>
                                    <div class="thread-meta">
                                        <span class="thread-count">ğŸ’¬ ${thread.promptCount}ä»¶</span>
                                        <span class="thread-time">${formatRelativeTime(thread.startTime)}</span>
                                    </div>
                                </div>
                                <span class="thread-toggle">â–¼</span>
                            </div>
                            <div class="thread-prompts" id="${thread.id}" style="display: none;">
                                ${promptList}
                            </div>
                        </div>
                    `
                }).join('')
            } catch (error) {
                container.innerHTML = '<div class="error">ä¼šè©±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>'
                console.error('Failed to load prompts:', error)
            }
        }

        // Select thread and show first prompt's response
        async function selectThreadPrompt(promptIndex, threadId, element) {
            // Toggle thread expansion
            const threadPrompts = document.getElementById(threadId)
            const isVisible = threadPrompts.style.display !== 'none'

            if (!isVisible) {
                threadPrompts.style.display = 'block'
                element.querySelector('.thread-toggle').textContent = 'â–²'
            } else {
                threadPrompts.style.display = 'none'
                element.querySelector('.thread-toggle').textContent = 'â–¼'
            }

            // Load the first prompt's response
            await loadResponse(currentEncodedPath, currentSessionId, promptIndex)

            // Highlight the first prompt in the thread
            document.querySelectorAll('.thread-prompt-item').forEach(el => el.classList.remove('active'))
            const firstPromptItem = threadPrompts.querySelector('.thread-prompt-item')
            if (firstPromptItem) {
                firstPromptItem.classList.add('active')
            }
        }

        // Toggle thread expansion (kept for potential future use)
        function toggleThread(threadId, element) {
            const threadPrompts = document.getElementById(threadId)
            const isVisible = threadPrompts.style.display !== 'none'

            if (isVisible) {
                threadPrompts.style.display = 'none'
                element.querySelector('.thread-toggle').textContent = 'â–¼'
            } else {
                threadPrompts.style.display = 'block'
                element.querySelector('.thread-toggle').textContent = 'â–²'
            }
        }

        // Select a prompt and load response
        async function selectPrompt(promptIndex, element) {
            // Remove previous active states
            document.querySelectorAll('.thread-prompt-item').forEach(el => el.classList.remove('active'))
            element.classList.add('active')

            // Load response
            await loadResponse(currentEncodedPath, currentSessionId, promptIndex)
        }

        // Render markdown content safely
        function renderMarkdown(content) {
            console.log('renderMarkdown called with content length:', content.length)
            console.log('marked available:', typeof marked !== 'undefined')
            console.log('DOMPurify available:', typeof DOMPurify !== 'undefined')
            console.log('hljs available:', typeof hljs !== 'undefined')

            if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
                console.warn('marked or DOMPurify not available, falling back to pre')
                return `<pre class="plain-text">${escapeHtml(content)}</pre>`
            }

            try {
                // Configure marked for better rendering
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: true,
                    mangle: false,
                    highlight: function (code, lang) {
                        if (typeof hljs !== 'undefined') {
                            if (lang && hljs.getLanguage(lang)) {
                                try {
                                    return hljs.highlight(code, { language: lang }).value
                                } catch (err) {
                                    console.warn('Highlight error:', err)
                                }
                            }
                            return hljs.highlightAuto(code).value
                        }
                        return code
                    }
                })

                const rawHtml = marked(content)
                console.log('Markdown rendered, HTML length:', rawHtml.length)
                const sanitized = DOMPurify.sanitize(rawHtml)
                console.log('HTML sanitized, final length:', sanitized.length)
                return sanitized
            } catch (e) {
                console.error('Markdown rendering error:', e)
                return `<pre class="plain-text">${escapeHtml(content)}</pre>`
            }
        }


        // Extract filename from text
        function extractFilename(text) {
            if (!text) return null

            // Common patterns
            const patterns = [
                /File Path: `?([^`\n]+)`?/i,
                /File: `?([^`\n]+)`?/i,
                /Updated `?([^`\n]+)`?/i,
                /Created `?([^`\n]+)`?/i,
                /^`([^`\n]+\.[a-z0-9]+)`:?/i, // Starts with `filename.ext`:
                /`([^`\n]+\.[a-z0-9]+)`/i // Contains `filename.ext`
            ]

            for (const pattern of patterns) {
                const match = text.match(pattern)
                if (match && match[1]) {
                    // Cleanup path, get basename if it's a long path
                    let path = match[1].trim()
                    if (path.includes('/')) {
                        path = path.split('/').pop()
                    }
                    return path
                }
            }
            return null
        }

        // Post-process code blocks to add Mac-style window headers
        function processCodeBlocks() {
            const pres = document.querySelectorAll('.message-content pre:not(.plain-text)')

            pres.forEach(pre => {
                // Skip if already processed
                if (pre.parentNode.classList.contains('code-window')) return

                // Try to find filename from previous context
                let filename = 'Code'
                let previousNode = pre.previousSibling

                // Look back a few nodes for filename info
                let attempts = 3
                while (previousNode && attempts > 0) {
                    if (previousNode.nodeType === Node.TEXT_NODE || previousNode.nodeType === Node.ELEMENT_NODE) {
                        const text = previousNode.textContent
                        const extracted = extractFilename(text)
                        if (extracted) {
                            filename = extracted
                            break
                        }
                    }
                    previousNode = previousNode.previousSibling
                    attempts--
                }

                // If extracts "Code" or similar generic terms, check language class
                if (filename === 'Code') {
                    const code = pre.querySelector('code')
                    if (code) {
                        const langClass = Array.from(code.classList).find(c => c.startsWith('language-'))
                        if (langClass) {
                            filename = langClass.replace('language-', '').toUpperCase()
                        }
                    }
                }

                // Create wrapper
                const wrapper = document.createElement('div')
                wrapper.className = 'code-window'

                // Create header
                const header = document.createElement('div')
                header.className = 'code-header'

                header.innerHTML = `
                    <div class="window-controls">
                        <span class="window-red"></span>
                        <span class="window-yellow"></span>
                        <span class="window-green"></span>
                    </div>
                    <div class="code-filename">${escapeHtml(filename)}</div>
                    <div class="copy-button">
                        <span>Copy</span>
                    </div>
                `

                // Setup Copy Button
                const copyBtn = header.querySelector('.copy-button')
                copyBtn.addEventListener('click', async () => {
                    const code = pre.querySelector('code')
                    const text = code ? code.textContent : pre.textContent

                    try {
                        await navigator.clipboard.writeText(text)
                        copyBtn.classList.add('copied')
                        copyBtn.innerHTML = 'Check âœ“'

                        setTimeout(() => {
                            copyBtn.classList.remove('copied')
                            copyBtn.innerHTML = '<span>Copy</span>'
                        }, 2000)
                    } catch (err) {
                        console.error('Failed to copy', err)
                    }
                })

                // Insert wrapper
                pre.parentNode.insertBefore(wrapper, pre)
                wrapper.appendChild(header)
                wrapper.appendChild(pre)
            })
        }

        // Load response for a prompt
        async function loadResponse(encodedPath, sessionId, promptIndex) {
            const container = document.getElementById('response-container')
            container.innerHTML = '<div class="loading">Loading response...</div>'

            try {
                const response = await fetch(`/api/projects/${encodedPath}/sessions/${sessionId}/prompts/${promptIndex}`)
                const data = await response.json()

                const promptHtml = data.prompt ? `
                    <div class="message-block prompt-block">
                        <div class="message-header">
                            <span class="role-badge user">ğŸ‘¤ User Prompt</span>
                            <span class="timestamp">${formatTime(data.prompt.timestamp)}</span>
                        </div>
                        <div class="message-content">
                            ${renderMarkdown(data.prompt.content)}
                        </div>
                    </div>
                ` : ''

                const responseHtml = data.response ? `
                    <div class="message-block response-block">
                        <div class="message-header">
                            <span class="role-badge assistant">ğŸ¤– Assistant Response</span>
                            <span class="timestamp">${formatTime(data.response.timestamp)}</span>
                        </div>
                        <div class="message-content">
                            ${renderMarkdown(data.response.content)}
                        </div>
                    </div>
                ` : '<div class="no-response">å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</div>'

                container.innerHTML = promptHtml + responseHtml

                // Process code blocks for Mac-style windows
                processCodeBlocks()

            } catch (error) {
                container.innerHTML = '<div class="error">å›ç­”ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>'
                console.error('Failed to load response:', error)
            }
        }

        // Add copy functionality to code blocks
        function addCopyButtons() {
            document.querySelectorAll('.message-content pre').forEach((pre) => {
                pre.style.cursor = 'pointer'
                pre.addEventListener('click', async (e) => {
                    const code = pre.querySelector('code')
                    const text = code ? code.textContent : pre.textContent

                    try {
                        await navigator.clipboard.writeText(text)

                        // Visual feedback
                        const originalBefore = window.getComputedStyle(pre, '::before').content
                        pre.setAttribute('data-copied', 'true')
                        pre.style.setProperty('--copy-text', '"Copied!"')

                        setTimeout(() => {
                            pre.removeAttribute('data-copied')
                            pre.style.removeProperty('--copy-text')
                        }, 2000)
                    } catch (err) {
                        console.error('Failed to copy:', err)
                    }
                })
            })
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('project-search')
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase()
                const projects = document.querySelectorAll('.project-item')

                projects.forEach(project => {
                    const projectName = project.querySelector('.project-name').textContent.toLowerCase()
                    if (projectName.includes(query)) {
                        project.style.display = 'block'
                    } else {
                        project.style.display = 'none'
                    }
                })
            })
        }

        // Utility functions
        function getProjectName(path) {
            const parts = path.split('/')
            return parts[parts.length - 1] || path
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp)
            return date.toLocaleString('ja-JP', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp)
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            })
        }

        function formatRelativeTime(timestamp) {
            const now = new Date()
            const date = new Date(timestamp)
            const diffMs = now - date
            const diffMinutes = Math.floor(diffMs / 60000)
            const diffHours = Math.floor(diffMs / 3600000)
            const diffDays = Math.floor(diffMs / 86400000)

            if (diffMinutes < 1) {
                return 'ãŸã£ãŸä»Š'
            } else if (diffMinutes < 60) {
                return `${diffMinutes}åˆ†å‰`
            } else if (diffHours < 24) {
                return `${diffHours}æ™‚é–“å‰`
            } else if (diffDays === 1) {
                return 'æ˜¨æ—¥'
            } else if (diffDays < 7) {
                return `${diffDays}æ—¥å‰`
            } else if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7)
                return `${weeks}é€±é–“å‰`
            } else if (diffDays < 365) {
                const months = Math.floor(diffDays / 30)
                return `${months}ãƒ¶æœˆå‰`
            } else {
                const years = Math.floor(diffDays / 365)
                return `${years}å¹´å‰`
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
        }
    </script>
</body>

</html>