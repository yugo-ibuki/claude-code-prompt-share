<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Session Viewer</title>
    <link rel="stylesheet" href="/static/style.css?v=18">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Force cache bust
        console.log('Page loaded at:', new Date().toISOString())
        console.log('Checking libraries...')
        window.addEventListener('load', function () {
            console.log('marked:', typeof marked)
            console.log('DOMPurify:', typeof DOMPurify)
            console.log('hljs:', typeof hljs)
        });
    </script>
</head>

<body>
    <div class="app-container">
        <!-- Left Sidebar: Projects -->
        <aside class="sidebar left-sidebar">
            <div class="sidebar-header">
                <h1>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Claude Sessions
                </h1>
                <div class="sort-controls">
                    <button class="sort-btn active" onclick="sortProjects('created')" title="Sort by Creation Date">
                        <span>ğŸ“… Created</span>
                    </button>
                    <button class="sort-btn" onclick="sortProjects('updated')" title="Sort by Last Update">
                        <span>ğŸ”„ Updated</span>
                    </button>
                </div>
                <div class="session-info">
                    {{ len .Projects }} Projects
                </div>
            </div>
            <div class="search-box" style="padding: 0 1rem 0.5rem;">
                <input type="text" id="project-search" class="search-input" placeholder="Search projects...">
            </div>
            <div class="projects-list" id="projects-list">
                {{ range .Projects }}
                {{ $latest := 0 }}
                {{ if gt (len .Sessions) 0 }}
                {{ $latest = (index .Sessions 0).StartTime.Unix }}
                {{ end }}

                {{ $earliest := $latest }}
                {{ range .Sessions }}
                {{ $earliest = .StartTime.Unix }}
                {{ end }}

                <div class="project-item"
                    onclick="selectProject('{{ .EncodedPath }}', '{{ .DecodedPath | getProjectName }}', this)"
                    data-encoded-path="{{ .EncodedPath }}" data-project-name="{{ .DecodedPath | getProjectName }}"
                    data-created="{{ $earliest }}" data-updated="{{ $latest }}">
                    <div class="project-header">
                        <span class="project-icon">ğŸ“‚</span>
                        <div class="project-name">{{ .DecodedPath | getProjectName }}</div>
                        <button class="archive-btn" onclick="archiveProject('{{ .EncodedPath }}', event)"
                            title="Archive Project">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
                {{ end }}
            </div>
        </aside>

        <!-- Middle Sidebar: Sessions -->
        <aside class="sidebar middle-sidebar">
            <div class="sidebar-header">
                <h2>ğŸ“ Sessions</h2>
                <div class="session-info" id="project-info">
                    <small>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                </div>
            </div>
            <div class="sessions-list" id="sessions-list">
                <div class="empty-state">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã¨<br>ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
        </aside>

        <!-- Main Content: Chat View -->
        <main class="main-content">
            <div class="content-header">
                <h2>ğŸ’¬ Chat History</h2>
                <div class="prompt-info" id="session-info">
                    <small>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                </div>
            </div>
            <div class="response-container chat-container" id="chat-container">
                <div class="empty-state">
                    <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                    <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹ã¨<br>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentEncodedPath = null
        let currentSessionId = null
        const messageContentMap = new Map()

        // Load projects on page load
        document.addEventListener('DOMContentLoaded', async () => {
            setupSearch()

            // Restore state from URL
            const params = new URLSearchParams(window.location.search)
            const projectParam = params.get('project')
            const sessionParam = params.get('session')

            if (projectParam) {
                const projectEl = document.querySelector(`.project-item[data-encoded-path="${projectParam}"]`)
                if (projectEl) {
                    await selectProject(projectParam, projectEl.dataset.projectName, projectEl, false)

                    if (sessionParam) {
                        const sessionEl = document.querySelector(`.session-item[data-session-id="${sessionParam}"]`)
                        if (sessionEl) {
                            await selectSession(projectParam, sessionParam, sessionEl, false)
                        }
                    }
                }
            }
        })

        window.addEventListener('popstate', () => {
            window.location.reload()
        })

        // Select a project and load its sessions
        async function selectProject(encodedPath, projectName, element, updateUrl = true) {
            // Remove previous active states
            document.querySelectorAll('.project-item').forEach(el => el.classList.remove('active'))
            element.classList.add('active')

            // Update project info
            document.getElementById('project-info').innerHTML = `<small>${projectName}</small>`

            if (updateUrl) {
                const newUrl = new URL(window.location)
                newUrl.searchParams.set('project', encodedPath)
                newUrl.searchParams.delete('session')
                window.history.pushState({}, '', newUrl)
            }

            // Load sessions
            await loadSessions(encodedPath)

            // Clear chat
            document.getElementById('chat-container').innerHTML = `
                <div class="empty-state">
                    <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹ã¨<br>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            `
            document.getElementById('session-info').innerHTML = '<small>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</small>'
        }

        // Load sessions for a project
        async function loadSessions(encodedPath) {
            const container = document.getElementById('sessions-list')
            container.innerHTML = '<div class="loading">Loading sessions...</div>'

            try {
                const response = await fetch(`/api/projects/${encodedPath}/sessions`)
                const sessions = await response.json()

                if (sessions.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p></div>'
                    return
                }

                container.innerHTML = sessions.map(session => `
                    <div class="session-item" onclick="selectSession('${encodedPath}', '${session.ID}', this)" data-session-id="${session.ID}">
                        <div class="session-date">${formatDate(session.StartTime)}</div>
                        <div class="session-preview">${escapeHtml(session.FirstMessage.substring(0, 50))}${session.FirstMessage.length > 50 ? '...' : ''}</div>
                        <div class="session-meta">
                            <span>ğŸ‘¤ ${session.UserMessageCount}</span>
                            <span>ğŸ¤– ${session.AssistantMessageCount}</span>
                        </div>
                        <button class="archive-btn" onclick="archiveSession('${session.ID}', event)" title="Archive Session">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `).join('')
            } catch (error) {
                container.innerHTML = '<div class="error">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>'
                console.error('Failed to load sessions:', error)
            }
        }

        // Select a session and load full chat history
        async function selectSession(encodedPath, sessionId, element, updateUrl = true) {
            // Remove previous active states
            document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'))
            element.classList.add('active')

            currentEncodedPath = encodedPath
            currentSessionId = sessionId

            if (updateUrl) {
                const newUrl = new URL(window.location)
                newUrl.searchParams.set('project', encodedPath)
                newUrl.searchParams.set('session', sessionId)
                window.history.pushState({}, '', newUrl)
            }

            // Update session info
            document.getElementById('session-info').innerHTML = `<small>Session: ${sessionId}</small>`

            // Load full chat history
            await loadFullChat(encodedPath, sessionId)
        }

        // Load full chat history
        async function loadFullChat(encodedPath, sessionId) {
            const container = document.getElementById('chat-container')
            container.innerHTML = '<div class="loading">Loading conversation...</div>'
            messageContentMap.clear()

            try {
                const response = await fetch(`/api/projects/${encodedPath}/sessions/${sessionId}/full`)
                const messages = await response.json()

                if (messages.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“</p></div>'
                    return
                }

                container.innerHTML = messages.map(msg => renderMessageBubble(msg)).join('')

                // Process code blocks
                processCodeBlocks()

            } catch (error) {
                container.innerHTML = '<div class="error">ä¼šè©±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>'
                console.error('Failed to load chat:', error)
            }
        }

        // Render a single message bubble
        function renderMessageBubble(msg) {
            const isUser = msg.role === 'user'
            const roleName = isUser ? 'User' : 'Claude'
            const badgeClass = isUser ? 'user-message' : 'assistant-message'
            const uuid = 'msg-' + Math.random().toString(36).substr(2, 9)

            // Store raw content for copying
            messageContentMap.set(uuid, msg.content)

            const contentHtml = renderMarkdown(msg.content)

            return `
                <div class="message-block ${badgeClass}">
                    <div class="message-header">
                        <div class="message-info">
                            <span class="role-badge">${isUser ? 'ğŸ‘¤' : 'ğŸ¤–'} ${roleName}</span>
                            <span class="timestamp">${formatTime(msg.timestamp)}</span>
                        </div>
                        <button class="message-copy-btn" onclick="copyMessage('${uuid}', this)" title="Copy message">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>Copy</span>
                        </button>
                    </div>
                    <div class="collapsible-container collapsed-content" id="${uuid}">
                        <div class="message-content">
                            ${contentHtml}
                        </div>
                        <div class="collapse-overlay">
                            <button class="show-more-btn" onclick="toggleContent('${uuid}')">Show More</button>
                        </div>
                    </div>
                </div>
            `
        }

        // Copy message content
        async function copyMessage(uuid, btn) {
            const content = messageContentMap.get(uuid)
            if (!content) return

            try {
                await navigator.clipboard.writeText(content)

                // Visual feedback
                const originalHtml = btn.innerHTML
                btn.classList.add('copied')
                btn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span>Copied!</span>
                `

                setTimeout(() => {
                    btn.classList.remove('copied')
                    btn.innerHTML = originalHtml
                }, 2000)
            } catch (err) {
                console.error('Failed to copy:', err)
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ')
            }
        }

        // Toggle content expansion
        function toggleContent(id) {
            const container = document.getElementById(id)
            if (container.classList.contains('collapsed-content')) {
                container.classList.remove('collapsed-content')
                container.classList.add('expanded-content')
                container.querySelector('.show-more-btn').textContent = 'Show Less'
            } else {
                container.classList.remove('expanded-content')
                container.classList.add('collapsed-content')
                container.querySelector('.show-more-btn').textContent = 'Show More'
            }
        }

        // Render markdown content safely
        function renderMarkdown(content) {
            console.log('renderMarkdown called with content length:', content.length)
            console.log('marked available:', typeof marked !== 'undefined')
            console.log('DOMPurify available:', typeof DOMPurify !== 'undefined')
            console.log('hljs available:', typeof hljs !== 'undefined')

            if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
                console.warn('marked or DOMPurify not available, falling back to pre')
                return `<pre class="plain-text">${escapeHtml(content)}</pre>`
            }

            try {
                // Configure marked for better rendering
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    headerIds: true,
                    mangle: false,
                    highlight: function (code, lang) {
                        if (typeof hljs !== 'undefined') {
                            if (lang && hljs.getLanguage(lang)) {
                                try {
                                    return hljs.highlight(code, { language: lang }).value
                                } catch (err) {
                                    console.warn('Highlight error:', err)
                                }
                            }
                            return hljs.highlightAuto(code).value
                        }
                        return code
                    }
                })

                const rawHtml = marked(content)
                console.log('Markdown rendered, HTML length:', rawHtml.length)
                const sanitized = DOMPurify.sanitize(rawHtml)
                console.log('HTML sanitized, final length:', sanitized.length)
                return sanitized
            } catch (e) {
                console.error('Markdown rendering error:', e)
                return `<pre class="plain-text">${escapeHtml(content)}</pre>`
            }
        }


        // Extract filename from text
        function extractFilename(text) {
            if (!text) return null

            // Common patterns
            const patterns = [
                /File Path: `?([^`\n]+)`?/i,
                /File: `?([^`\n]+)`?/i,
                /Updated `?([^`\n]+)`?/i,
                /Created `?([^`\n]+)`?/i,
                /^`([^`\n]+\.[a-z0-9]+)`:?/i, // Starts with `filename.ext`:
                /`([^`\n]+\.[a-z0-9]+)`/i // Contains `filename.ext`
            ]

            for (const pattern of patterns) {
                const match = text.match(pattern)
                if (match && match[1]) {
                    // Cleanup path, get basename if it's a long path
                    let path = match[1].trim()
                    if (path.includes('/')) {
                        path = path.split('/').pop()
                    }
                    return path
                }
            }
            return null
        }

        // Post-process code blocks to add Mac-style window headers
        function processCodeBlocks() {
            const pres = document.querySelectorAll('.message-content pre:not(.plain-text)')

            pres.forEach(pre => {
                // Skip if already processed
                if (pre.parentNode.classList.contains('code-window')) return

                // Try to find filename from previous context
                let filename = 'Code'
                let previousNode = pre.previousSibling

                // Look back a few nodes for filename info
                let attempts = 3
                while (previousNode && attempts > 0) {
                    if (previousNode.nodeType === Node.TEXT_NODE || previousNode.nodeType === Node.ELEMENT_NODE) {
                        const text = previousNode.textContent
                        const extracted = extractFilename(text)
                        if (extracted) {
                            filename = extracted
                            break
                        }
                    }
                    previousNode = previousNode.previousSibling
                    attempts--
                }

                // If extracts "Code" or similar generic terms, check language class
                if (filename === 'Code') {
                    const code = pre.querySelector('code')
                    if (code) {
                        const langClass = Array.from(code.classList).find(c => c.startsWith('language-'))
                        if (langClass) {
                            filename = langClass.replace('language-', '').toUpperCase()
                        }
                    }
                }

                // Create wrapper
                const wrapper = document.createElement('div')
                wrapper.className = 'code-window'

                // Create header
                const header = document.createElement('div')
                header.className = 'code-header'

                header.innerHTML = `
                    <div class="window-controls">
                        <span class="window-red"></span>
                        <span class="window-yellow"></span>
                        <span class="window-green"></span>
                    </div>
                    <div class="code-filename">${escapeHtml(filename)}</div>
                    <div class="copy-button">
                        <span>Copy</span>
                    </div>
                `

                // Setup Copy Button
                const copyBtn = header.querySelector('.copy-button')
                copyBtn.addEventListener('click', async () => {
                    const code = pre.querySelector('code')
                    const text = code ? code.textContent : pre.textContent

                    try {
                        await navigator.clipboard.writeText(text)
                        copyBtn.classList.add('copied')
                        copyBtn.innerHTML = 'Check âœ“'

                        setTimeout(() => {
                            copyBtn.classList.remove('copied')
                            copyBtn.innerHTML = '<span>Copy</span>'
                        }, 2000)
                    } catch (err) {
                        console.error('Failed to copy', err)
                    }
                })

                // Insert wrapper
                pre.parentNode.insertBefore(wrapper, pre)
                wrapper.appendChild(header)
                wrapper.appendChild(pre)
            })
        }

        // Load response for a prompt
        async function loadResponse(encodedPath, sessionId, promptIndex) {
            const container = document.getElementById('response-container')
            container.innerHTML = '<div class="loading">Loading response...</div>'

            try {
                const response = await fetch(`/api/projects/${encodedPath}/sessions/${sessionId}/prompts/${promptIndex}`)
                const data = await response.json()

                const promptHtml = data.prompt ? `
                    <div class="message-block prompt-block">
                        <div class="message-header">
                            <span class="role-badge user">ğŸ‘¤ User Prompt</span>
                            <span class="timestamp">${formatTime(data.prompt.timestamp)}</span>
                        </div>
                        <div class="message-content">
                            ${renderMarkdown(data.prompt.content)}
                        </div>
                    </div>
                ` : ''

                const responseHtml = data.response ? `
                    <div class="message-block response-block">
                        <div class="message-header">
                            <span class="role-badge assistant">ğŸ¤– Assistant Response</span>
                            <span class="timestamp">${formatTime(data.response.timestamp)}</span>
                        </div>
                        <div class="message-content">
                            ${renderMarkdown(data.response.content)}
                        </div>
                    </div>
                ` : '<div class="no-response">å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“</div>'

                container.innerHTML = promptHtml + responseHtml

                // Process code blocks for Mac-style windows
                processCodeBlocks()

            } catch (error) {
                container.innerHTML = '<div class="error">å›ç­”ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>'
                console.error('Failed to load response:', error)
            }
        }

        // Add copy functionality to code blocks
        function addCopyButtons() {
            document.querySelectorAll('.message-content pre').forEach((pre) => {
                pre.style.cursor = 'pointer'
                pre.addEventListener('click', async (e) => {
                    const code = pre.querySelector('code')
                    const text = code ? code.textContent : pre.textContent

                    try {
                        await navigator.clipboard.writeText(text)

                        // Visual feedback
                        const originalBefore = window.getComputedStyle(pre, '::before').content
                        pre.setAttribute('data-copied', 'true')
                        pre.style.setProperty('--copy-text', '"Copied!"')

                        setTimeout(() => {
                            pre.removeAttribute('data-copied')
                            pre.style.removeProperty('--copy-text')
                        }, 2000)
                    } catch (err) {
                        console.error('Failed to copy:', err)
                    }
                })
            })
        }

        // Sort projects
        function sortProjects(criteria) {
            const container = document.querySelector('.projects-list')
            const projects = Array.from(document.querySelectorAll('.project-item'))

            // Update buttons
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active')
                if (btn.onclick.toString().includes(criteria)) {
                    btn.classList.add('active')
                }
            })

            projects.sort((a, b) => {
                const aVal = parseInt(a.dataset[criteria] || 0)
                const bVal = parseInt(b.dataset[criteria] || 0)

                // Descending order (newest/latest first) for Updated
                // Descending order (newest first) for Created? Usually "Creation Date" sort means Newest First?
                // The user asked: "First sort by creation date, then allows sort by updated".
                // Usually "Sort by Created" implies Newest Created First or Oldest?
                // Standard file explorers: Name (ASC), Date Modified (DESC), Date Created (DESC).
                // Let's assume Newest First (Desc) for both dates is the most useful default.

                return bVal - aVal
            })

            // Re-append
            projects.forEach(p => container.appendChild(p))
        }

        // Initialize sort (Default: Created)
        window.addEventListener('load', () => {
            sortProjects('created')
        })

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('project-search')
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase()
                const projects = document.querySelectorAll('.project-item')

                projects.forEach(project => {
                    const projectName = project.querySelector('.project-name').textContent.toLowerCase()
                    if (projectName.includes(query)) {
                        project.style.display = 'block'
                    } else {
                        project.style.display = 'none'
                    }
                })
            })
        }

        // Utility functions
        function getProjectName(path) {
            const parts = path.split('/')
            return parts[parts.length - 1] || path
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp)
            return date.toLocaleString('ja-JP', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp)
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            })
        }

        function formatRelativeTime(timestamp) {
            const now = new Date()
            const date = new Date(timestamp)
            const diffMs = now - date
            const diffMinutes = Math.floor(diffMs / 60000)
            const diffHours = Math.floor(diffMs / 3600000)
            const diffDays = Math.floor(diffMs / 86400000)

            if (diffMinutes < 1) {
                return 'ãŸã£ãŸä»Š'
            } else if (diffMinutes < 60) {
                return `${diffMinutes}åˆ†å‰`
            } else if (diffHours < 24) {
                return `${diffHours}æ™‚é–“å‰`
            } else if (diffDays === 1) {
                return 'æ˜¨æ—¥'
            } else if (diffDays < 7) {
                return `${diffDays}æ—¥å‰`
            } else if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7)
                return `${weeks}é€±é–“å‰`
            } else if (diffDays < 365) {
                const months = Math.floor(diffDays / 30)
                return `${months}ãƒ¶æœˆå‰`
            } else {
                const years = Math.floor(diffDays / 365)
                return `${years}å¹´å‰`
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
        }

        async function archiveSession(sessionId, event) {
            event.stopPropagation() // Prevent selection
            if (!confirm('ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ')) return

            try {
                const response = await fetch(`/api/sessions/${sessionId}/archive`, {
                    method: 'POST'
                })

                if (response.ok) {
                    // Remove from view
                    const el = document.querySelector(`.session-item[data-session-id="${sessionId}"]`)
                    if (el) {
                        el.style.opacity = '0'
                        setTimeout(() => el.remove(), 300)
                    }
                } else {
                    alert('å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ')
                }
            } catch (e) {
                console.error(e)
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
            }
        }

        async function archiveProject(encodedPath, event) {
            event.stopPropagation() // Prevent selection
            if (!confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™ã‹ï¼Ÿ')) return

            try {
                const response = await fetch(`/api/projects/${encodedPath}/archive`, {
                    method: 'POST'
                })

                if (response.ok) {
                    // Remove from view
                    const el = document.querySelector(`.project-item[data-encoded-path="${encodedPath}"]`)
                    if (el) {
                        el.style.opacity = '0'
                        setTimeout(() => el.remove(), 300)
                    }

                    // If active project, clear detail view
                    if (encodedPath === currentEncodedPath) {
                        document.getElementById('sessions-list').innerHTML = '<div class="empty-state"><p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã™ã‚‹ã¨<br>ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p></div>'
                        document.getElementById('chat-container').innerHTML = '<div class="empty-state"><p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹ã¨<br>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p></div>'
                        document.getElementById('project-info').innerHTML = '<small>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</small>'
                        document.getElementById('session-info').innerHTML = '<small>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</small>'
                    }
                } else {
                    alert('å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ')
                }
            } catch (e) {
                console.error(e)
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
            }
        }
    </script>
</body>

</html>